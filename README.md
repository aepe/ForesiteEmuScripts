# ForesiteEmu scripts

[ForesiteEmu](https://github.com/luisdamiano/ForesiteEmu/) is an R package that generates samples to emulate a crop computer model as a combination of Latin Hypercube Samples from three family of inputs: soil variables, weather variables, management decisions. This repository hosts a family of R scripts using `ForesiteEmu` to draw a specific set of samples and push it the current Foresite PostgreSQL Server.

### Scripts

#### 1. `sample_from_design.R` 

Generate samples according to the following protocol and write them to csv files inside a folder called `./out/`.

* Draw LHSs from an empirical dataset of soil measurements.
    * The function `lhs_soil` expands soil measurements at each map unit,
      identified by `unitKey`, into a soil profile with cuts at depth
      `soilLayers`.
* Draw LHSs from an empirical dataset of weather measurements.
    * The function `lhs_weather` takes a dataset in long format.
* Draw LHSs from an empirical dataset of management decisions.
    * If such an empirical dataset does not exist, you can use
      `management_population` to generate a large sample of decisions mimicking
      all possible distributions.
* Combine all draws into runs.
    * The elements of the largest soil/weather/management samples are run only once.
    * The elements of the other two samples are recycled so that each is used
      in approximately the same number of runs.

#### 2. `push_to_sqlserver.R`

Read csv files in the `./out/` folder, assumed to had been generated by `sample_from_design.R`, and push it to the FORESITE PostgreSQL Server. If the tables do not exist, they will be created. If the tables exist, they will be overwritten.

Tables:

* soil_samples: each sample is uniquely identified by `soil_sample_id`.
  * Soil profiles are stored in long format: per each `soil_sample_id`, there are 7 rows corresponding to `layer` values in 20, 40, 60, 80, 100, 150, 200 cm.
* weather_samples: each sample is uniquely identified by `weather_sample_id`.
  * Weather curves are stored in long format: per each `weather_sample_id`, there are 365 rows corresponding to `yday` values in 1, ..., 365.
* mgmt_samples: each sample is uniquely identified by `mgmt_sample_id`.
* runs_samples: each run is uniquely identified by `run_id`.
  * Save APSIM's output for yield and Nitrogen in the `y` and `N` columns respectively.
  * Add columns for any other output variables that you want to emulate.

### Example query

After running both scripts, running this query on the SQL Server,

```
SELECT count(*) FROM soil_samples
UNION ALL SELECT count(*) FROM weather_samples
UNION ALL SELECT count(*) FROM mgmt_samples
UNION ALL SELECT count(*) FROM runs_samples
```

produces the following output,

```
count
"1400"
"10950"
"50000"
"52285"
```

